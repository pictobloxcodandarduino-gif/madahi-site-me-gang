<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>سایت مداحی الحسین - پنل مدیریت و نمایش پیشرفته</title>
<!-- Google Fonts for a modern, clean look with Persian support -->
<link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;700;900&display=swap" rel="stylesheet">
<!-- Font Awesome for icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

<style>
/* ==================== Base Styles & Variables ==================== */
:root {
    --bg-color-dark: #0d0d0d;
    --card-bg-dark: #1a1a1a;
    --input-bg-dark: #2a2a2a;
    --text-color-dark: #e0e0e0;
    --border-color-dark: #333;
    --primary-color: #008cff; /* A vibrant blue */
    --secondary-color: #005bb5; /* A darker blue */
    --accent-color: #2ecc71; /* Green from animated background */
    --error-color: #ff4d4d;
    --success-color: #4CAF50;
    --warning-color: #ffc107;
    --info-color: #17a2b8;
    --hover-color: #007bff;
    --button-text-color: #ffffff;
    --shadow-dark: 0 5px 20px rgba(0, 0, 0, 0.5);
    --shadow-light: 0 5px 20px rgba(0, 0, 0, 0.15);

    --bg-color-light: #f0f2f5;
    --card-bg-light: #ffffff;
    --input-bg-light: #e0e0e0;
    --text-color-light: #333333;
    --border-color-light: #ccc;
}

/* ==================== Animated Background ==================== */
body {
    background-color: var(--bg-color-dark);
    color: var(--text-color-dark);
    font-family: 'Vazirmatn', sans-serif;
    margin: 0;
    padding: 0; /* Changed to 0 as padding will be on main content */
    line-height: 1.6;
    transition: background-color 0.5s ease-in-out, color 0.5s ease-in-out;
    direction: rtl; /* Ensure right-to-left */
    overflow-x: hidden; /* Prevent horizontal scroll from animation */
    min-height: 100vh; /* Ensure body takes full height for background */
    position: relative; /* For pseudo-element positioning */
    z-index: 1; /* Ensure content is above background */
}

body::before {
    content: '';
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: -1; /* Place behind content */
    background:
        linear-gradient(135deg, #2ecc71 0%, #ffffff 50%, #3498db 100%), /* Green, White, Sky Blue */
        linear-gradient(45deg, #3498db 0%, #2ecc71 50%, #ffffff 100%); /* Sky Blue, Green, White */
    background-size: 300% 300%; /* Make gradients larger to allow movement */
    animation: backgroundAnimation 20s ease infinite alternate; /* Smooth, looping animation */
    opacity: 0.2; /* Subtle background */
}

body.light-mode {
    background-color: var(--bg-color-light);
    color: var(--text-color-light);
}

body.light-mode::before {
    background:
        linear-gradient(135deg, #a8e6cf 0%, #f0f2f5 50%, #a2d9ff 100%), /* Lighter versions for light mode */
        linear-gradient(45deg, #a2d9ff 0%, #a8e6cf 50%, #f0f2f5 100%);
    background-size: 300% 300%;
    animation: backgroundAnimation 20s ease infinite alternate;
    opacity: 0.4; /* Slightly more visible in light mode */
}

@keyframes backgroundAnimation {
    0% { background-position: 0% 50%, 100% 50%; }
    50% { background-position: 100% 50%, 0% 50%; }
    100% { background-position: 0% 50%, 100% 50%; }
}

/* ==================== Scrollbar Customization ==================== */
::-webkit-scrollbar {
    width: 12px;
}

::-webkit-scrollbar-track {
    background: var(--card-bg-dark);
    border-radius: 10px;
}

::-webkit-scrollbar-thumb {
    background: var(--primary-color);
    border-radius: 10px;
    border: 3px solid var(--card-bg-dark);
}

::-webkit-scrollbar-thumb:hover {
    background: var(--hover-color);
}

body.light-mode ::-webkit-scrollbar-track {
    background: var(--input-bg-light);
}

body.light-mode ::-webkit-scrollbar-thumb {
    background: var(--secondary-color);
    border: 3px solid var(--input-bg-light);
}

body.light-mode ::-webkit-scrollbar-thumb:hover {
    background: var(--primary-color);
}

/* ==================== Typography & Headings ==================== */
h1, h2, h3, h4 {
    text-align: center;
    color: var(--primary-color);
    margin-bottom: 25px;
    font-weight: 800;
    transition: color 0.3s ease;
    text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.2);
}

body.light-mode h1,
body.light-mode h2,
body.light-mode h3,
body.light-mode h4 {
    color: var(--secondary-color);
    text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.1);
}

p {
    margin: 10px 0;
    font-weight: 300;
}

a {
    color: var(--primary-color);
    text-decoration: none;
    transition: color 0.3s ease;
}

a:hover {
    color: var(--hover-color);
    text-decoration: underline;
}

/* ==================== Container Styling ==================== */
.container {
    max-width: 960px; /* Slightly wider */
    margin: 25px auto; /* More vertical spacing */
    padding: 35px;
    background-color: var(--card-bg-dark);
    border-radius: 18px; /* Softer corners */
    box-shadow: var(--shadow-dark);
    transition: background-color 0.5s ease-in-out, box-shadow 0.5s ease-in-out;
    position: relative; /* For z-index stacking */
    z-index: 10; /* Ensure containers are above background */
    border: 1px solid rgba(255, 255, 255, 0.05); /* Subtle border */
    animation: fadeIn 0.8s ease-out; /* Fade in effect */
}

body.light-mode .container {
    background-color: var(--card-bg-light);
    box-shadow: var(--shadow-light);
    border: 1px solid rgba(0, 0, 0, 0.05);
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
}

/* ==================== Navigation Bar ==================== */
.navbar {
    background-color: var(--card-bg-dark);
    padding: 15px 0;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
    position: sticky;
    top: 0;
    z-index: 100;
    border-bottom: 1px solid var(--border-color-dark);
    transition: background-color 0.5s ease-in-out, border-color 0.5s ease-in-out;
}

body.light-mode .navbar {
    background-color: var(--card-bg-light);
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    border-bottom: 1px solid var(--border-color-light);
}

.navbar-content {
    max-width: 960px;
    margin: 0 auto;
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0 20px;
}

.nav-links {
    list-style: none;
    margin: 0;
    padding: 0;
    display: flex;
    gap: 25px;
}

.nav-links a {
    color: var(--text-color-dark);
    font-weight: 500;
    font-size: 17px;
    padding: 8px 12px;
    border-radius: 8px;
    transition: background-color 0.3s ease, color 0.3s ease, transform 0.2s ease;
    position: relative;
    overflow: hidden;
}

body.light-mode .nav-links a {
    color: var(--text-color-light);
}

.nav-links a::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background-color: var(--primary-color);
    opacity: 0.1;
    transition: left 0.3s ease;
    z-index: -1;
}

.nav-links a:hover::before {
    left: 0;
}

.nav-links a:hover {
    color: var(--hover-color);
    transform: translateY(-2px);
}

.nav-logo {
    font-size: 28px;
    font-weight: 900;
    color: var(--primary-color);
    display: flex;
    align-items: center;
    gap: 10px;
    text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.2);
}

.nav-logo i {
    color: var(--accent-color);
}

/* ==================== Form Elements ==================== */
.form-group {
    margin-bottom: 25px;
    position: relative; /* For validation messages */
}

label {
    display: block;
    margin-bottom: 10px;
    font-weight: 700;
    color: var(--text-color-dark);
    font-size: 15px;
}

body.light-mode label {
    color: var(--text-color-light);
}

input[type="text"],
input[type="password"],
input[type="email"],
select,
textarea {
    width: calc(100% - 30px);
    padding: 16px; /* Slightly larger padding */
    margin: 0;
    border-radius: 12px; /* Softer corners */
    border: 1px solid var(--border-color-dark);
    background-color: var(--input-bg-dark);
    color: var(--text-color-dark);
    font-size: 16px;
    transition: border-color 0.3s ease, background-color 0.3s ease, color 0.3s ease, box-shadow 0.3s ease;
    box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
}

body.light-mode input[type="text"],
body.light-mode input[type="password"],
body.light-mode input[type="email"],
body.light-mode select,
body.light-mode textarea {
    border: 1px solid var(--border-color-light);
    background-color: var(--input-bg-light);
    color: var(--text-color-light);
    box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.05);
}

input[type="file"] {
    display: block;
    width: 100%;
    padding: 10px 0;
    color: var(--text-color-dark);
}

body.light-mode input[type="file"] {
    color: var(--text-color-light);
}

input::placeholder, textarea::placeholder {
    color: #999;
    opacity: 0.8;
}

input:focus, select:focus, textarea:focus {
    outline: none;
    border-color: var(--primary-color);
    box-shadow: 0 0 0 4px rgba(0, 140, 255, 0.4); /* More prominent focus */
}

input.invalid, textarea.invalid {
    border-color: var(--error-color);
    box-shadow: 0 0 0 4px rgba(255, 77, 77, 0.3);
}

/* ==================== Buttons ==================== */
button {
    width: 100%;
    padding: 16px; /* Larger buttons */
    margin: 12px 0;
    border-radius: 12px;
    border: none;
    font-size: 18px;
    font-weight: bold;
    cursor: pointer;
    background-color: var(--primary-color);
    color: var(--button-text-color);
    transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
    box-shadow: 0 4px 10px rgba(0, 140, 255, 0.3);
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 10px;
}

button:hover {
    background-color: var(--hover-color);
    transform: translateY(-3px);
    box-shadow: 0 6px 15px rgba(0, 140, 255, 0.4);
}

button:disabled {
    background-color: #555;
    cursor: not-allowed;
    transform: none;
    box-shadow: none;
}

.btn-secondary {
    background-color: #6c757d;
    box-shadow: 0 4px 10px rgba(108, 117, 125, 0.3);
}

.btn-secondary:hover {
    background-color: #5a6268;
    box-shadow: 0 6px 15px rgba(108, 117, 125, 0.4);
}

.btn-danger {
    background-color: var(--error-color);
    box-shadow: 0 4px 10px rgba(255, 77, 77, 0.3);
}

.btn-danger:hover {
    background-color: #cc0000;
    box-shadow: 0 6px 15px rgba(255, 77, 77, 0.4);
}

/* ==================== Messages & Feedback ==================== */
.message {
    padding: 14px;
    margin-top: 15px;
    border-radius: 10px;
    font-size: 15px;
    text-align: center;
    opacity: 0;
    transform: translateY(10px);
    animation: fadeInSlideUp 0.5s forwards ease-out;
    border: 1px solid; /* Generic border for messages */
}

.message.error {
    background-color: rgba(255, 77, 77, 0.15);
    color: var(--error-color);
    border-color: var(--error-color);
}

.message.success {
    background-color: rgba(76, 175, 80, 0.15);
    color: var(--success-color);
    border-color: var(--success-color);
}

.message.info {
    background-color: rgba(23, 162, 184, 0.15);
    color: var(--info-color);
    border-color: var(--info-color);
}

@keyframes fadeInSlideUp {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

.loading-spinner {
    border: 4px solid rgba(255, 255, 255, 0.3);
    border-top: 4px solid var(--button-text-color);
    border-radius: 50%;
    width: 22px;
    height: 22px;
    animation: spin 1s linear infinite;
    display: inline-block;
    vertical-align: middle;
    margin-right: 10px;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.validation-error {
    color: var(--error-color);
    font-size: 13px;
    margin-top: 5px;
    text-align: right;
    display: block;
    animation: fadeIn 0.3s ease-out;
}

/* ==================== Madahi List & Items ==================== */
#madahiList {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 30px; /* Larger gap */
    margin-top: 35px;
}

.m-item {
    background-color: var(--card-bg-dark);
    padding: 22px;
    border-radius: 15px;
    text-align: center;
    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
    transition: transform 0.3s ease, box-shadow 0.3s ease, background-color 0.5s ease-in-out;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    border: 1px solid rgba(255, 255, 255, 0.08);
}

body.light-mode .m-item {
    background-color: var(--card-bg-light);
    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
    border: 1px solid rgba(0, 0, 0, 0.08);
}

.m-item:hover {
    transform: translateY(-8px) scale(1.02); /* More pronounced hover */
    box-shadow: 0 12px 30px rgba(0, 0, 0, 0.4);
}

img.cover {
    width: 1000px; /* طول عکس */
    height: 500px; /* ارتفاع عکس */
    border-radius: 10px;
    object-fit: cover;
    margin-bottom: 18px;
    transition: transform 0.4s ease-out;
    border: 1px solid rgba(255, 255, 255, 0.1);
}

.m-item:hover img.cover {
    transform: scale(1.05) rotateZ(1deg); /* Subtle rotate effect */
}

.m-item h3 {
    margin-top: 0;
    margin-bottom: 12px;
    font-size: 22px;
    color: var(--primary-color);
    flex-grow: 1;
    line-height: 1.3;
}

body.light-mode .m-item h3 {
    color: var(--secondary-color);
}

audio {
    width: 100%;
    margin-top: 18px;
    height: 50px; /* Taller audio player */
    background-color: var(--input-bg-dark);
    border-radius: 10px;
    box-shadow: inset 0 1px 5px rgba(0, 0, 0, 0.2);
    transition: background-color 0.3s ease;
}

body.light-mode audio {
    background-color: var(--input-bg-light);
    box-shadow: inset 0 1px 5px rgba(0, 0, 0, 0.05);
}

.admin-actions {
    margin-top: 20px;
    display: flex;
    gap: 12px; /* Larger gap */
}

.admin-actions button {
    width: auto;
    flex-grow: 1;
    padding: 12px 18px;
    font-size: 15px;
    margin: 0;
    border-radius: 10px;
}

/* ==================== Modals ==================== */
.modal {
    display: none;
    position: fixed;
    z-index: 2000; /* Highest z-index */
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow: auto;
    background-color: rgba(0,0,0,0.7); /* Darker overlay */
    justify-content: center;
    align-items: center;
    backdrop-filter: blur(5px); /* Frosted glass effect */
    animation: overlayFadeIn 0.3s ease-out forwards;
}

@keyframes overlayFadeIn {
    from { background-color: rgba(0,0,0,0); }
    to { background-color: rgba(0,0,0,0.7); }
}

.modal-content {
    background-color: var(--card-bg-dark);
    margin: auto;
    padding: 35px;
    border-radius: 20px;
    max-width: 550px; /* Wider modal */
    text-align: center;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.6);
    position: relative;
    transform: translateY(-80px) scale(0.9);
    opacity: 0;
    animation: modalOpen 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55) forwards; /* Bouncy animation */
    border: 1px solid rgba(255, 255, 255, 0.1);
}

body.light-mode .modal-content {
    background-color: var(--card-bg-light);
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
    border: 1px solid rgba(0, 0, 0, 0.1);
}

@keyframes modalOpen {
    to { transform: translateY(0) scale(1); opacity: 1; }
}

.close-button {
    color: #aaa;
    position: absolute;
    top: 20px;
    left: 20px;
    font-size: 32px; /* Larger close button */
    font-weight: bold;
    cursor: pointer;
    transition: color 0.3s ease, transform 0.2s ease;
}

.close-button:hover,
.close-button:focus {
    color: var(--primary-color);
    transform: rotate(90deg);
}

.modal-content h3 {
    color: var(--primary-color);
    margin-top: 0;
    margin-bottom: 25px;
    font-size: 26px;
}

.modal-actions {
    display: flex;
    justify-content: center;
    gap: 20px; /* Larger gap */
    margin-top: 30px;
}

.modal-actions button {
    width: fit-content;
    padding: 14px 30px;
    font-size: 17px;
    margin: 0;
}

/* ==================== Utility & Responsive ==================== */
.hidden { display: none !important; }

.text-center { text-align: center; }

#theme-switcher {
    position: fixed;
    top: 25px;
    left: 25px;
    background-color: var(--input-bg-dark);
    color: var(--text-color-dark);
    border: 1px solid var(--border-color-dark);
    border-radius: 50%;
    width: 50px;
    height: 50px;
    display: flex;
    justify-content: center;
    align-items: center;
    cursor: pointer;
    font-size: 26px; /* Larger icon */
    box-shadow: 0 3px 12px rgba(0, 0, 0, 0.3);
    transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease, transform 0.2s ease;
    z-index: 101; /* Above navbar */
}

body.light-mode #theme-switcher {
    background-color: var(--input-bg-light);
    color: var(--text-color-light);
    border: 1px solid var(--border-color-light);
}

#theme-switcher:hover {
    background-color: var(--primary-color);
    color: var(--button-text-color);
    border-color: var(--primary-color);
    transform: scale(1.1) rotate(15deg);
}

#search-sort-container {
    display: flex;
    flex-wrap: wrap;
    gap: 20px; /* Larger gap */
    margin-bottom: 30px;
    justify-content: center;
    align-items: center;
}

#search-sort-container input,
#search-sort-container select {
    flex: 1;
    min-width: 220px; /* Slightly wider min-width */
}

@media (max-width: 992px) {
    .navbar-content { flex-direction: column; gap: 15px; }
    .nav-links { margin-top: 10px; }
}

@media (max-width: 768px) {
    body { padding: 0; } /* Remove body padding */
    .container { padding: 25px; margin: 15px auto; border-radius: 12px; }
    h1, h2, h3 { font-size: 28px; margin-bottom: 20px; }
    .m-item { padding: 18px; border-radius: 10px; }
    .admin-actions { flex-direction: column; gap: 8px; }
    .admin-actions button { width: 100%; padding: 10px; font-size: 14px; }
    #theme-switcher { top: 15px; left: 15px; width: 40px; height: 40px; font-size: 22px; }
    .nav-links { flex-wrap: wrap; justify-content: center; gap: 15px; }
    .navbar-content { padding: 0 15px; }
    .modal-content { padding: 25px; border-radius: 15px; }
    .modal-actions { flex-direction: column; gap: 10px; }
    .modal-actions button { width: 100%; }
}

@media (max-width: 480px) {
    h1 { font-size: 24px; }
    h2, h3 { font-size: 22px; }
    .nav-links a { font-size: 15px; padding: 6px 10px; }
    .nav-logo { font-size: 24px; }
    input, button, select, textarea { font-size: 14px; padding: 12px; }
    .message { font-size: 13px; padding: 10px; }
    .m-item h3 { font-size: 18px; }
    img.cover { height: 180px; }
    #search-sort-container { flex-direction: column; }
    #search-sort-container input, #search-sort-container select { min-width: unset; width: 100%; }
}

/* File input custom styling for better UX */
.file-input-wrapper {
    position: relative;
    overflow: hidden;
    display: block; /* Changed to block for full width */
    width: 100%;
    margin-bottom: 20px;
}

.file-input-wrapper input[type=file] {
    font-size: 100px;
    position: absolute;
    left: 0;
    top: 0;
    opacity: 0;
    cursor: pointer;
    width: 100%; /* Ensure it covers the button */
    height: 100%;
}

.file-input-button {
    border: 1px solid var(--border-color-dark);
    background-color: var(--input-bg-dark);
    color: var(--text-color-dark);
    padding: 15px;
    border-radius: 10px;
    cursor: pointer;
    display: block;
    text-align: center;
    transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
    box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
}

body.light-mode .file-input-button {
    border: 1px solid var(--border-color-light);
    background-color: var(--input-bg-light);
    color: var(--text-color-light);
}

.file-input-button:hover {
    background-color: var(--primary-color);
    color: var(--button-text-color);
    border-color: var(--primary-color);
}

.file-preview {
    margin-top: 15px;
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 15px;
    flex-wrap: wrap;
    background-color: var(--input-bg-dark);
    border-radius: 10px;
    padding: 15px;
    border: 1px dashed var(--border-color-dark);
    min-height: 80px; /* Ensure visibility even if empty */
}

body.light-mode .file-preview {
    background-color: var(--input-bg-light);
    border: 1px dashed var(--border-color-light);
}

.file-preview img, .file-preview audio {
    max-width: 180px; /* Larger preview */
    max-height: 120px;
    border-radius: 10px;
    object-fit: cover;
    border: 2px solid var(--primary-color); /* More prominent border */
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
}

/* Pagination styles */
.pagination {
    display: flex;
    justify-content: center;
    margin-top: 40px;
    gap: 12px;
    flex-wrap: wrap; /* Allow wrapping on small screens */
}

.pagination button {
    width: fit-content;
    padding: 12px 22px;
    font-size: 16px;
    margin: 0;
    border-radius: 10px;
    min-width: 50px; /* Ensure buttons are not too small */
    background-color: var(--card-bg-dark); /* Default button color */
    color: var(--text-color-dark);
    border: 1px solid var(--border-color-dark);
    box-shadow: none; /* Override default button shadow */
}

body.light-mode .pagination button {
    background-color: var(--card-bg-light);
    color: var(--text-color-light);
    border: 1px solid var(--border-color-light);
}

.pagination button:hover {
    background-color: var(--hover-color);
    color: var(--button-text-color);
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0, 140, 255, 0.2);
}

.pagination button.active {
    background-color: var(--primary-color);
    color: var(--button-text-color);
    border-color: var(--primary-color);
    box-shadow: 0 4px 10px rgba(0, 140, 255, 0.3);
    font-weight: bold;
}

/* Back to Top Button */
#backToTopBtn {
    display: none; /* Hidden by default */
    position: fixed; /* Fixed position */
    bottom: 30px; /* Place at the bottom */
    right: 30px; /* Place at the right */
    z-index: 99; /* High z-index */
    border: none; /* Remove borders */
    outline: none; /* Remove outline */
    background-color: var(--primary-color); /* Set a background color */
    color: white; /* Text color */
    cursor: pointer; /* Add a mouse pointer on hover */
    padding: 15px 20px; /* Some padding */
    border-radius: 50%; /* Rounded corners */
    font-size: 22px; /* Increase font size */
    box-shadow: 0 4px 15px rgba(0, 140, 255, 0.4);
    transition: background-color 0.3s ease, transform 0.3s ease, opacity 0.3s ease;
}

#backToTopBtn:hover {
    background-color: var(--hover-color); /* Darker background on hover */
    transform: translateY(-5px) scale(1.05);
}

/* About Section Styles */
#aboutSection {
    padding: 40px;
    text-align: justify;
    font-size: 17px;
    line-height: 1.8;
}

#aboutSection h2 {
    margin-bottom: 30px;
}

#aboutSection p {
    margin-bottom: 15px;
}

#aboutSection ul {
    list-style: none;
    padding: 0;
    margin-top: 20px;
}

#aboutSection ul li {
    background-color: var(--input-bg-dark);
    padding: 12px 18px;
    margin-bottom: 10px;
    border-radius: 10px;
    display: flex;
    align-items: center;
    gap: 15px;
    border: 1px solid var(--border-color-dark);
    transition: background-color 0.3s ease, border-color 0.3s ease;
}

body.light-mode #aboutSection ul li {
    background-color: var(--input-bg-light);
    border: 1px solid var(--border-color-light);
}

#aboutSection ul li i {
    color: var(--accent-color);
    font-size: 20px;
}

/* Contact Section Styles */
#contactSection {
    padding: 40px;
}

#contactSection h2 {
    margin-bottom: 30px;
}

.contact-info {
    display: flex;
    flex-direction: column;
    gap: 20px;
    margin-top: 25px;
}

.contact-item {
    display: flex;
    align-items: center;
    gap: 20px;
    background-color: var(--input-bg-dark);
    padding: 15px 20px;
    border-radius: 12px;
    border: 1px solid var(--border-color-dark);
    transition: background-color 0.3s ease, border-color 0.3s ease;
}

body.light-mode .contact-item {
    background-color: var(--input-bg-light);
    border: 1px solid var(--border-color-light);
}

.contact-item i {
    color: var(--primary-color);
    font-size: 28px;
    min-width: 30px;
    text-align: center;
}

.contact-item span {
    font-size: 17px;
    color: var(--text-color-dark);
}

body.light-mode .contact-item span {
    color: var(--text-color-light);
}

/* Footer Styles */
footer {
    margin-top: 60px;
    padding: 30px 20px;
    background-color: var(--card-bg-dark);
    border-top: 1px solid var(--border-color-dark);
    box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.3);
    text-align: center;
    font-size: 14px;
    color: #777;
    transition: background-color 0.5s ease-in-out, border-color 0.5s ease-in-out;
}

body.light-mode footer {
    background-color: var(--card-bg-light);
    border-top: 1px solid var(--border-color-light);
    box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
}

.social-links {
    margin-top: 20px;
    display: flex;
    justify-content: center;
    gap: 25px;
}

.social-links a {
    color: #777;
    font-size: 24px;
    transition: color 0.3s ease, transform 0.2s ease;
}

.social-links a:hover {
    color: var(--primary-color);
    transform: translateY(-5px) scale(1.1);
}

</style>
</head>
<body>
<!-- Theme Switcher -->
<div id="theme-switcher" onclick="toggleTheme()"><i class="fas fa-moon"></i></div>

<!-- Back to Top Button -->
<button onclick="scrollToTop()" id="backToTopBtn" title="برو بالا"><i class="fas fa-arrow-up"></i></button>

<!-- Navigation Bar -->
<nav class="navbar">
    <div class="navbar-content">
        <a href="#" class="nav-logo"><i class="fas fa-kaaba"></i>الحسین</a>
        <ul class="nav-links">
            <li><a href="#madahiListSection"><i class="fas fa-music"></i> مداحی‌ها</a></li>
            <li><a href="#addMadahiSection" class="admin-only hidden"><i class="fas fa-plus-circle"></i> افزودن</a></li>
            <li><a href="#aboutSection"><i class="fas fa-info-circle"></i> درباره ما</a></li>
            <li><a href="#contactSection"><i class="fas fa-envelope"></i> تماس با ما</a></li>
            <li id="navLoginLink"><a href="#loginSection"><i class="fas fa-sign-in-alt"></i> ورود</a></li>
            <li id="navLogoutLink" class="hidden"><a href="#" onclick="logout()"><i class="fas fa-sign-out-alt"></i> خروج</a></li>
        </ul>
    </div>
</nav>

<main>
    <!-- Login Section -->
    <section id="loginSection" class="container">
        <h2><i class="fas fa-user-circle"></i> ورود به پنل کاربری</h2>
        <form id="loginForm">
            <div class="form-group">
                <label for="email"><i class="fas fa-at"></i> ایمیل:</label>
                <input id="email" type="email" placeholder="ایمیل خود را وارد کنید" required aria-describedby="emailError">
                <p id="emailError" class="validation-error hidden">فرمت ایمیل صحیح نیست.</p>
            </div>
            <div class="form-group">
                <label for="password"><i class="fas fa-lock"></i> رمز عبور:</label>
                <input id="password" type="password" placeholder="رمز عبور (حداقل 6 کاراکتر)" required minlength="6" aria-describedby="passwordError">
                <p id="passwordError" class="validation-error hidden">رمز عبور باید حداقل 6 کاراکتر باشد.</p>
            </div>
            <button type="submit" id="loginButton">
                <span id="loginButtonText">ورود</span>
                <span class="loading-spinner hidden" id="loginSpinner"></span>
            </button>
            <p id="loginMessage" class="message hidden" role="alert"></p>
        </form>
    </section>

    <!-- Add Madahi Section -->
    <section id="addMadahiSection" class="container hidden">
        <h2><i class="fas fa-cloud-upload-alt"></i> افزودن مداحی جدید</h2>
        <form id="addMadahiForm">
            <div class="form-group">
                <label for="madahiTitle"><i class="fas fa-heading"></i> نام مداحی:</label>
                <input id="madahiTitle" type="text" placeholder="عنوان مداحی را وارد کنید" required aria-describedby="titleError">
                <p id="titleError" class="validation-error hidden">نام مداحی نمی‌تواند خالی باشد.</p>
            </div>
            <div class="form-group">
                <label><i class="fas fa-file-audio"></i> فایل صوتی:</label>
                <div class="file-input-wrapper">
                    <input id="audioFile" type="file" accept="audio/*" required aria-describedby="audioFileError">
                    <div class="file-input-button"><i class="fas fa-upload"></i> انتخاب فایل صوتی</div>
                </div>
                <div id="audioPreview" class="file-preview"></div>
                <p id="audioFileError" class="validation-error hidden">لطفاً یک فایل صوتی انتخاب کنید.</p>
            </div>
            <div class="form-group">
                <label><i class="fas fa-image"></i> عکس کاور:</label>
                <div class="file-input-wrapper">
                    <input id="imageFile" type="file" accept="image/*" required aria-describedby="imageFileError">
                    <div class="file-input-button"><i class="fas fa-image"></i> انتخاب عکس کاور</div>
                </div>
                <div id="imagePreview" class="file-preview"></div>
                <p id="imageFileError" class="validation-error hidden">لطفاً یک عکس کاور انتخاب کنید.</p>
            </div>
            <button type="submit" id="addMadahiButton">
                <span id="addMadahiButtonText">افزودن مداحی</span>
                <span class="loading-spinner hidden" id="addMadahiSpinner"></span>
            </button>
            <button type="button" class="btn-secondary" onclick="clearAddForm()"><i class="fas fa-eraser"></i> پاک کردن فرم</button>
            <p id="addMadahiMessage" class="message hidden" role="alert"></p>
        </form>
    </section>

    <!-- Madahi List Section -->
    <section id="madahiListSection" class="container">
        <h2><i class="fas fa-list-ul"></i> مداحی‌های موجود</h2>
        <div id="search-sort-container">
            <input type="text" id="searchMadahi" placeholder="جستجو بر اساس نام مداحی..." onkeyup="filterMadahi()" aria-label="جستجو مداحی">
            <select id="sortMadahi" onchange="filterMadahi()" aria-label="مرتب سازی مداحی">
                <option value="latest">جدیدترین</option>
                <option value="oldest">قدیمی‌ترین</option>
                <option value="title-asc">نام (الفبا صعودی)</option>
                <option value="title-desc">نام (الفبا نزولی)</option>
            </select>
        </div>
        <div id="madahiList">
            <!-- Madahi items will be loaded here -->
        </div>
        <div id="pagination" class="pagination">
            <!-- Pagination buttons will be loaded here -->
        </div>
        <p id="noMadahiMessage" class="text-center message info hidden" role="status"><i class="fas fa-info-circle"></i> هیچ مداحی یافت نشد.</p>
    </section>

    <!-- About Us Section -->
    <section id="aboutSection" class="container">
        <h2><i class="fas fa-info-circle"></i> درباره ما</h2>
        <p>سایت مداحی الحسین با هدف گردآوری و نشر مداحی‌های اهل بیت (علیهم السلام) برای دسترسی آسان‌تر عاشقان و ارادتمندان طراحی و راه‌اندازی شده است. ما بر این باوریم که نشر معارف اهل بیت و نوای دلنشین مداحی‌ها، می‌تواند چراغ راهی برای هدایت و آرامش دل‌ها باشد.</p>
        <p>تیم ما متشکل از مجموعه‌ای از خادمان اهل بیت است که با عشق و ارادت، در تلاشند تا آرشیوی جامع و باکیفیت از مداحی‌ها را فراهم آورند. این سایت یک بستر فرهنگی برای تمامی مسلمانان و شیعیان جهان است تا بتوانند به راحتی به محتوای صوتی و تصویری ارزشمند دسترسی پیدا کنند.</p>
        <h3><i class="fas fa-clipboard-list"></i> اهداف ما:</h3>
        <ul>
            <li><i class="fas fa-check-circle"></i> فراهم آوردن آرشیو جامع و دسته‌بندی شده از مداحی‌ها.</li>
            <li><i class="fas fa-check-circle"></i> امکان دسترسی آسان و سریع به محتوای مورد نظر.</li>
            <li><i class="fas fa-check-circle"></i> ایجاد فضایی برای تبادل فرهنگی و معنوی.</li>
            <li><i class="fas fa-check-circle"></i> حمایت از مداحان و هنرمندان متعهد.</li>
            <li><i class="fas fa-check-circle"></i> به‌روزرسانی مداوم محتوا با جدیدترین آثار.</li>
        </ul>
        <p>از همراهی شما سپاسگزاریم و امیدواریم این فضا محفل انس و الفت با اهل بیت عصمت و طهارت باشد.</p>
    </section>

    <!-- Contact Us Section -->
    <section id="contactSection" class="container">
        <h2><i class="fas fa-headset"></i> تماس با ما</h2>
        <p class="text-center">برای هرگونه سوال، پیشنهاد یا انتقاد می‌توانید با ما در ارتباط باشید. نظرات شما برای بهبود خدمات ما بسیار ارزشمند است.</p>
        <div class="contact-info">
            <div class="contact-item">
                <i class="fas fa-map-marker-alt"></i>
                <span>تهران_خیابان ارده شیر</span>
            </div>
            <div class="contact-item">
                <i class="fas fa-phone-alt"></i>
                <span>989198519327+</span>
            </div>
            <div class="contact-item">
                <i class="fas fa-envelope"></i>
                <span>pictobloxcodandarduino@gmail.com</span>
            </div>
            <div class="contact-item">
                <i class="fas fa-globe"></i>
                <span>https://github.com/pictobloxcodandarduino-gif/alhosaini.git</span>
            </div>
        </div>
        <form id="contactForm" style="margin-top: 30px;">
            <h3><i class="fas fa-comment-dots"></i> ارسال پیام</h3>
            <div class="form-group">
                <label for="contactName"><i class="fas fa-user"></i> نام شما:</label>
                <input id="contactName" type="text" placeholder="نام و نام خانوادگی" required>
            </div>
            <div class="form-group">
                <label for="contactEmail"><i class="fas fa-at"></i> ایمیل شما:</label>
                <input id="contactEmail" type="email" placeholder="ایمیل برای پاسخگویی" required>
            </div>
            <div class="form-group">
                <label for="contactMessage"><i class="fas fa-comment-alt"></i> پیام شما:</label>
                <textarea id="contactMessage" rows="6" placeholder="پیام خود را اینجا بنویسید..." required></textarea>
            </div>
            <button type="submit">ارسال پیام <i class="fas fa-paper-plane"></i></button>
            <p id="contactMessageStatus" class="message hidden" role="alert"></p>
        </form>
    </section>
</main>

<!-- Edit Madahi Modal -->
<div id="editMadahiModal" class="modal">
    <div class="modal-content">
        <span class="close-button" onclick="closeModal('editMadahiModal')">&times;</span>
        <h3><i class="fas fa-edit"></i> ویرایش مداحی</h3>
        <form id="editMadahiForm">
            <input type="hidden" id="editMadahiId">
            <div class="form-group">
                <label for="editMadahiTitle"><i class="fas fa-heading"></i> نام مداحی:</label>
                <input id="editMadahiTitle" type="text" required aria-describedby="editTitleError">
                <p id="editTitleError" class="validation-error hidden">نام مداحی نمی‌تواند خالی باشد.</p>
            </div>
            <div class="form-group">
                <label><i class="fas fa-file-audio"></i> فایل صوتی جدید (اختیاری):</label>
                <div class="file-input-wrapper">
                    <input id="editAudioFile" type="file" accept="audio/*">
                    <div class="file-input-button"><i class="fas fa-upload"></i> انتخاب فایل صوتی جدید</div>
                </div>
                <div id="editAudioPreview" class="file-preview"></div>
            </div>
            <div class="form-group">
                <label><i class="fas fa-image"></i> عکس کاور جدید (اختیاری):</label>
                <div class="file-input-wrapper">
                    <input id="editImageFile" type="file" accept="image/*">
                    <div class="file-input-button"><i class="fas fa-image"></i> انتخاب عکس کاور جدید</div>
                </div>
                <div id="editImagePreview" class="file-preview"></div>
            </div>
            <div class="modal-actions">
                <button type="submit" id="saveEditButton"><i class="fas fa-save"></i> ذخیره تغییرات</button>
                <button type="button" class="btn-secondary" onclick="closeModal('editMadahiModal')"><i class="fas fa-times-circle"></i> انصراف</button>
            </div>
        </form>
        <p id="editMadahiMessage" class="message hidden" role="alert"></p>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div id="deleteConfirmModal" class="modal">
    <div class="modal-content">
        <span class="close-button" onclick="closeModal('deleteConfirmModal')">&times;</span>
        <h3><i class="fas fa-trash-alt"></i> تایید حذف</h3>
        <p>آیا از حذف "<strong id="deleteMadahiTitle"></strong>" مطمئن هستید؟ این عمل غیرقابل بازگشت است.</p>
        <div class="modal-actions">
            <button class="btn-danger" id="confirmDeleteButton"><i class="fas fa-check-circle"></i> حذف</button>
            <button class="btn-secondary" onclick="closeModal('deleteConfirmModal')"><i class="fas fa-times-circle"></i> انصراف</button>
        </div>
    </div>
</div>

<footer>
    <p>&copy; 2025 سایت مداحی الحسین. تمامی حقوق محفوظ است.</p>
    <div class="social-links">
        <a href="https://t.me/alhossein" target="_blank" aria-label="تلگرام"><i class="fab fa-telegram-plane"></i></a>
        <a href="https://instagram.com/alhossein" target="_blank" aria-label="اینستاگرام"><i class="fab fa-instagram"></i></a>
        <a href="https://twitter.com/alhossein" target="_blank" aria-label="توییتر"><i class="fab fa-twitter"></i></a>
        <a href="https://facebook.com/alhossein" target="_blank" aria-label="فیسبوک"><i class="fab fa-facebook-f"></i></a>
    </div>
</footer>

<script>
// ==================== Global Variables & Constants ====================
const ADMIN_PASSWORD = "ahmadreza@ah"; // Admin password for demonstration
const DB_NAME = "MadahiDB"; // IndexedDB database name
const DB_VERSION = 1; // IndexedDB version
const STORE_NAME = "madahiStore"; // IndexedDB object store name
const ITEMS_PER_PAGE = 8; // Number of madahi items to display per page for better UX

let db; // IndexedDB database instance
let allMadahi = []; // Cache for all madahi items loaded from IndexedDB
let currentPage = 1; // Current page for pagination

// ==================== IndexedDB Setup ====================
/**
 * Opens the IndexedDB database. If the database doesn't exist or its version is lower,
 * it creates or upgrades the object store.
 * @returns {Promise<IDBDatabase>} A promise that resolves with the database instance.
 */
async function openDatabase() {
    return new Promise((resolve, reject) => {
        const request = indexedDB.open(DB_NAME, DB_VERSION);

        request.onerror = event => {
            console.error("IndexedDB error:", event.target.error);
            reject("خطا در باز کردن دیتابیس. لطفاً مرورگر خود را بررسی کنید.");
        };

        request.onsuccess = event => {
            db = event.target.result;
            console.log("IndexedDB opened successfully.");
            resolve(db);
        };

        request.onupgradeneeded = event => {
            const db = event.target.result;
            if (!db.objectStoreNames.contains(STORE_NAME)) {
                console.log("Creating new object store:", STORE_NAME);
                const store = db.createObjectStore(STORE_NAME, { keyPath: "id", autoIncrement: true });
                store.createIndex("time", "time", { unique: false }); // Index for sorting by time
                store.createIndex("title", "title", { unique: false }); // Index for sorting/searching by title
            }
        };
    });
}

// ==================== User Authentication & Role Management ====================
/**
 * Retrieves the current user's role from session storage.
 * @returns {string|null} The user's role ("admin", "member"), or null if not logged in.
 */
function getRole() {
    return sessionStorage.getItem("role");
}

/**
 * Checks if a user is currently logged in.
 * @returns {boolean} True if a role is set in session storage, false otherwise.
 */
function isLoggedIn() {
    return getRole() !== null;
}

/**
 * Sets the login state and updates the UI based on the user's role.
 * @param {string} role - The role of the logged-in user ("admin" or "member").
 * @param {string} email - The email of the logged-in user.
 */
function setLoginState(role, email) {
    sessionStorage.setItem("role", role);
    sessionStorage.setItem("email", email);
    console.log(`User logged in: Role=${role}, Email=${email}`);
    updateUIForRole(); // Update visibility of sections and nav links
}

/**
 * Logs out the current user and resets the UI.
 */
function logout() {
    sessionStorage.removeItem("role");
    sessionStorage.removeItem("email");
    console.log("User logged out.");
    updateUIForRole();
    // Show login section and hide add madahi section
    document.getElementById("loginSection").classList.remove("hidden");
    document.getElementById("addMadahiSection").classList.add("hidden");
    document.getElementById("loginForm").reset(); // Clear login form
    displayMessage("loginMessage", "با موفقیت از حساب کاربری خود خارج شدید.", "success");
    // Scroll to login section after logout
    document.getElementById("loginSection").scrollIntoView({ behavior: 'smooth' });
}

/**
 * Updates the visibility of UI elements (sections, navigation links) based on the user's role.
 */
function updateUIForRole() {
    const role = getRole();
    const loginSection = document.getElementById("loginSection");
    const addMadahiSection = document.getElementById("addMadahiSection");
    const adminNavLinks = document.querySelectorAll(".admin-only");
    const navLoginLink = document.getElementById("navLoginLink");
    const navLogoutLink = document.getElementById("navLogoutLink");

    // Hide all role-specific elements first
    loginSection.classList.add("hidden");
    addMadahiSection.classList.add("hidden");
    adminNavLinks.forEach(link => link.classList.add("hidden"));
    navLoginLink.classList.remove("hidden"); // Default to showing login
    navLogoutLink.classList.add("hidden");

    if (role === "admin") {
        addMadahiSection.classList.remove("hidden");
        adminNavLinks.forEach(link => link.classList.remove("hidden"));
        navLoginLink.classList.add("hidden");
        navLogoutLink.classList.remove("hidden");
    } else if (role === "member") {
        navLoginLink.classList.add("hidden");
        navLogoutLink.classList.remove("hidden");
    } else {
        // Not logged in
        loginSection.classList.remove("hidden");
    }
    loadMadahiItems(); // Reload madahi items to show/hide admin buttons
}

// ==================== Utility Functions ====================
/**
 * Displays a temporary message to the user.
 * @param {string} elementId - The ID of the HTML element where the message should be displayed.
 * @param {string} msg - The message text.
 * @param {string} type - The type of message ("success", "error", "info").
 */
function displayMessage(elementId, msg, type) {
    const msgElement = document.getElementById(elementId);
    if (!msgElement) {
        console.warn(`Message element with ID '${elementId}' not found.`);
        return;
    }

    msgElement.textContent = msg;
    msgElement.className = `message ${type}`; // Apply class for styling
    msgElement.classList.remove("hidden");
    msgElement.setAttribute('aria-live', 'assertive'); // Announce to screen readers

    // Automatically hide message after 5 seconds
    setTimeout(() => {
        msgElement.classList.add("hidden");
        msgElement.removeAttribute('aria-live');
    }, 5000);
}

/**
 * Shows a loading spinner and disables a button during an async operation.
 * @param {string} buttonId - The ID of the button element.
 * @param {string} spinnerId - The ID of the spinner element within the button.
 * @param {string} textId - The ID of the text span within the button.
 */
function showSpinner(buttonId, spinnerId, textId) {
    document.getElementById(buttonId).disabled = true;
    document.getElementById(textId).classList.add("hidden");
    document.getElementById(spinnerId).classList.remove("hidden");
}

/**
 * Hides a loading spinner and re-enables a button after an async operation.
 * @param {string} buttonId - The ID of the button element.
 * @param {string} spinnerId - The ID of the spinner element within the button.
 * @param {string} textId - The ID of the text span within the button.
 */
function hideSpinner(buttonId, spinnerId, textId) {
    document.getElementById(buttonId).disabled = false;
    document.getElementById(textId).classList.remove("hidden");
    document.getElementById(spinnerId).classList.add("hidden");
}

/**
 * Clears a form by resetting it and removing any file previews or validation messages.
 * @param {string} formId - The ID of the form element.
 */
function clearForm(formId) {
    document.getElementById(formId).reset();
    document.querySelectorAll(`#${formId} .file-preview`).forEach(preview => preview.innerHTML = '');
    document.querySelectorAll(`#${formId} .validation-error`).forEach(msg => msg.classList.add('hidden'));
    document.querySelectorAll(`#${formId} input.invalid, #${formId} textarea.invalid`).forEach(el => el.classList.remove('invalid'));
    console.log(`Form '${formId}' cleared.`);
}

/**
 * Validates an email address using a regular expression.
 * @param {string} email - The email string to validate.
 * @returns {boolean} True if the email is valid, false otherwise.
 */
function validateEmail(email) {
    const re = /^(([^<>()[\]\\.,;:\s@"]+(\.[^<>()[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
    return re.test(String(email).toLowerCase());
}

/**
 * Scrolls the window to the top of the page.
 */
function scrollToTop() {
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

// ==================== Theme Switching ====================
/**
 * Toggles between dark and light themes. Stores the preference in local storage.
 */
function toggleTheme() {
    document.body.classList.toggle('light-mode');
    const themeSwitcher = document.getElementById('theme-switcher');
    if (document.body.classList.contains('light-mode')) {
        themeSwitcher.innerHTML = '<i class="fas fa-sun"></i>'; // Sun icon for light mode
        localStorage.setItem('theme', 'light');
    } else {
        themeSwitcher.innerHTML = '<i class="fas fa-moon"></i>'; // Moon icon for dark mode
        localStorage.setItem('theme', 'dark');
    }
    console.log("Theme toggled.");
}

/**
 * Loads the user's preferred theme from local storage on page load.
 */
function loadTheme() {
    if (localStorage.getItem('theme') === 'light') {
        document.body.classList.add('light-mode');
        document.getElementById('theme-switcher').innerHTML = '<i class="fas fa-sun"></i>';
    } else {
        document.body.classList.remove('light-mode'); // Default to dark if no preference or 'dark'
        document.getElementById('theme-switcher').innerHTML = '<i class="fas fa-moon"></i>';
    }
    console.log("Theme loaded from local storage.");
}

// ==================== Modal Handling ====================
/**
 * Opens a modal by making it visible.
 * @param {string} modalId - The ID of the modal element.
 */
function openModal(modalId) {
    document.getElementById(modalId).style.display = 'flex';
    console.log(`Modal '${modalId}' opened.`);
}

/**
 * Closes a modal by hiding it. Also clears any messages or form data within the modal.
 * @param {string} modalId - The ID of the modal element.
 */
function closeModal(modalId) {
    document.getElementById(modalId).style.display = 'none';
    // Clear any messages in the modal
    document.querySelectorAll(`#${modalId} .message`).forEach(msg => msg.classList.add('hidden'));
    // Reset forms within modals
    if (modalId === 'editMadahiModal') {
        clearForm('editMadahiForm');
    }
    console.log(`Modal '${modalId}' closed.`);
}

// ==================== Event Listeners ====================
document.addEventListener("DOMContentLoaded", async () => {
    console.log("DOM Content Loaded. Initializing app...");
    loadTheme(); // Load theme preference
    await openDatabase(); // Open IndexedDB
    updateUIForRole(); // Update UI based on login status
    loadMadahiItems(); // Load and display madahi items

    // Show/hide back to top button based on scroll position
    window.onscroll = function() {
        if (document.body.scrollTop > 200 || document.documentElement.scrollTop > 200) {
            document.getElementById("backToTopBtn").style.display = "block";
        } else {
            document.getElementById("backToTopBtn").style.display = "none";
        }
    };
});

// Login Form Submission
document.getElementById("loginForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    console.log("Login form submitted.");

    const emailInput = document.getElementById("email");
    const passwordInput = document.getElementById("password");
    const emailError = document.getElementById("emailError");
    const passwordError = document.getElementById("passwordError");

    // Reset validation errors
    emailError.classList.add("hidden");
    passwordError.classList.add("hidden");
    emailInput.classList.remove("invalid");
    passwordInput.classList.remove("invalid");

    let isValid = true;
    if (!validateEmail(emailInput.value.trim())) {
        emailError.classList.remove("hidden");
        emailInput.classList.add("invalid");
        isValid = false;
    }
    if (passwordInput.value.trim().length < 6) {
        passwordError.classList.remove("hidden");
        passwordInput.classList.add("invalid");
        isValid = false;
    }

    if (!isValid) {
        displayMessage("loginMessage", "لطفاً اطلاعات ورودی را به درستی تکمیل کنید.", "error");
        return;
    }

    showSpinner("loginButton", "loginSpinner", "loginButtonText");

    // Simulate API call delay for better UX
    await new Promise(resolve => setTimeout(resolve, 1500));

    const email = emailInput.value.trim();
    const password = passwordInput.value.trim();

    if (password === ADMIN_PASSWORD) {
        setLoginState("admin", email);
        displayMessage("loginMessage", "ورود مدیر سیستم با موفقیت انجام شد. خوش آمدید!", "success");
        clearForm("loginForm");
        document.getElementById("madahiListSection").scrollIntoView({ behavior: 'smooth' }); // Scroll to content
    } else {
        setLoginState("member", email);
        displayMessage("loginMessage", `ورود کاربر ${email} با موفقیت انجام شد.`, "success");
        clearForm("loginForm");
        document.getElementById("madahiListSection").scrollIntoView({ behavior: 'smooth' }); // Scroll to content
    }
    hideSpinner("loginButton", "loginSpinner", "loginButtonText");
});

// Add Madahi Form Submission
document.getElementById("addMadahiForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    console.log("Add Madahi form submitted.");

    const titleInput = document.getElementById('madahiTitle');
    const audioFileInput = document.getElementById('audioFile');
    const imageFileInput = document.getElementById('imageFile');
    const titleError = document.getElementById('titleError');
    const audioFileError = document.getElementById('audioFileError');
    const imageFileError = document.getElementById('imageFileError');

    // Reset validation errors
    titleError.classList.add("hidden");
    audioFileError.classList.add("hidden");
    imageFileError.classList.add("hidden");
    titleInput.classList.remove("invalid");
    audioFileInput.classList.remove("invalid");
    imageFileInput.classList.remove("invalid");

    let isValid = true;
    if (!titleInput.value.trim()) {
        titleError.classList.remove("hidden");
        titleInput.classList.add("invalid");
        isValid = false;
    }
    if (!audioFileInput.files[0]) {
        audioFileError.classList.remove("hidden");
        audioFileInput.classList.add("invalid");
        isValid = false;
    }
    if (!imageFileInput.files[0]) {
        imageFileError.classList.remove("hidden");
        imageFileInput.classList.add("invalid");
        isValid = false;
    }

    if (!isValid) {
        displayMessage("addMadahiMessage", "لطفاً تمام فیلدهای الزامی را پر کنید.", "error");
        return;
    }

    if (getRole() !== "admin") {
        displayMessage("addMadahiMessage", "شما اجازه افزودن مداحی ندارید! لطفاً با حساب مدیر وارد شوید.", "error");
        return;
    }

    showSpinner("addMadahiButton", "addMadahiSpinner", "addMadahiButtonText");

    try {
        const transaction = db.transaction([STORE_NAME], "readwrite");
        const store = transaction.objectStore(STORE_NAME);

        const newItem = {
            title: titleInput.value.trim(),
            audio: audioFileInput.files[0],
            image: imageFileInput.files[0],
            time: Date.now() // Timestamp for sorting
        };

        await new Promise((resolve, reject) => {
            const request = store.add(newItem);
            request.onsuccess = () => resolve();
            request.onerror = event => reject(event.target.error);
        });

        clearForm("addMadahiForm");
        displayMessage("addMadahiMessage", "مداحی جدید با موفقیت به لیست اضافه شد.", "success");
        await loadMadahiItems(); // Reload to show new item
        document.getElementById("madahiListSection").scrollIntoView({ behavior: 'smooth' }); // Scroll to content
    } catch (error) {
        console.error("Error adding madahi:", error);
        displayMessage("addMadahiMessage", `خطا در افزودن مداحی: ${error.message || error}`, "error");
    } finally {
        hideSpinner("addMadahiButton", "addMadahiSpinner", "addMadahiButtonText");
    }
});

// File input change listeners for previews
document.getElementById('audioFile').addEventListener('change', (e) => previewFile(e.target, 'audioPreview', 'audio'));
document.getElementById('imageFile').addEventListener('change', (e) => previewFile(e.target, 'imagePreview', 'image'));
document.getElementById('editAudioFile').addEventListener('change', (e) => previewFile(e.target, 'editAudioPreview', 'audio'));
document.getElementById('editImageFile').addEventListener('change', (e) => previewFile(e.target, 'editImagePreview', 'image'));

/**
 * Displays a preview of a selected file (image or audio).
 * @param {HTMLInputElement} input - The file input element.
 * @param {string} previewElementId - The ID of the container element for the preview.
 * @param {string} type - The type of file ("image" or "audio").
 */
function previewFile(input, previewElementId, type) {
    const previewContainer = document.getElementById(previewElementId);
    previewContainer.innerHTML = ''; // Clear previous previews

    if (input.files && input.files[0]) {
        const file = input.files[0];
        const reader = new FileReader();

        reader.onload = (e) => {
            if (type === 'image') {
                const img = document.createElement('img');
                img.src = e.target.result;
                img.alt = 'پیش‌نمایش عکس کاور';
                previewContainer.appendChild(img);
            } else if (type === 'audio') {
                const audio = document.createElement('audio');
                audio.controls = true;
                audio.src = e.target.result;
                audio.title = 'پیش‌نمایش فایل صوتی';
                previewContainer.appendChild(audio);
            }
        };
        reader.readAsDataURL(file);
    }
}

/**
 * Clears the "Add Madahi" form and displays a success message.
 */
function clearAddForm() {
    clearForm("addMadahiForm");
    displayMessage("addMadahiMessage", "فرم افزودن مداحی پاک شد.", "info");
}

// Contact Form Submission
document.getElementById("contactForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    const name = document.getElementById('contactName').value.trim();
    const email = document.getElementById('contactEmail').value.trim();
    const message = document.getElementById('contactMessage').value.trim();
    const statusMessage = document.getElementById('contactMessageStatus');

    if (!name || !email || !message) {
        displayMessage("contactMessageStatus", "لطفاً تمام فیلدهای تماس را پر کنید.", "error");
        return;
    }
    if (!validateEmail(email)) {
        displayMessage("contactMessageStatus", "فرمت ایمیل شما صحیح نیست.", "error");
        return;
    }

    // Simulate sending message
    statusMessage.textContent = "در حال ارسال پیام...";
    statusMessage.className = "message info";
    statusMessage.classList.remove("hidden");

    await new Promise(resolve => setTimeout(resolve, 2000));

    displayMessage("contactMessageStatus", "پیام شما با موفقیت ارسال شد. در اسرع وقت پاسخ خواهیم داد.", "success");
    document.getElementById('contactForm').reset();
    console.log("Contact form submitted:", { name, email, message });
});


// ==================== Madahi Display & Management ====================
/**
 * Fetches all madahi items from IndexedDB.
 * @returns {Promise<Array<Object>>} A promise that resolves with an array of madahi objects.
 */
async function getAllMadahiFromDB() {
    return new Promise((resolve, reject) => {
        const transaction = db.transaction([STORE_NAME], "readonly");
        const store = transaction.objectStore(STORE_NAME);
        const request = store.getAll();

        request.onsuccess = event => resolve(event.target.result);
        request.onerror = event => reject(event.target.error);
    });
}

/**
 * Loads all madahi items, then filters, sorts, and renders them.
 */
async function loadMadahiItems() {
    try {
        allMadahi = await getAllMadahiFromDB();
        console.log(`Loaded ${allMadahi.length} madahi items.`);
        filterMadahi(); // Apply search/sort/pagination after loading
    } catch (error) {
        console.error("Error loading madahi items:", error);
        displayMessage("madahiListSection", "خطا در بارگذاری مداحی‌ها. لطفاً صفحه را رفرش کنید.", "error");
    }
}

/**
 * Filters and sorts the cached madahi items based on user input, then triggers rendering.
 */
function filterMadahi() {
    const searchTerm = document.getElementById('searchMadahi').value.toLowerCase();
    const sortBy = document.getElementById('sortMadahi').value;

    let filtered = allMadahi.filter(item =>
        item.title.toLowerCase().includes(searchTerm)
    );

    // Sort the filtered items
    switch (sortBy) {
        case 'latest':
            filtered.sort((a, b) => b.time - a.time);
            break;
        case 'oldest':
            filtered.sort((a, b) => a.time - b.time);
            break;
        case 'title-asc':
            filtered.sort((a, b) => a.title.localeCompare(b.title, 'fa', { sensitivity: 'base' })); // Persian-aware sort
            break;
        case 'title-desc':
            filtered.sort((a, b) => b.title.localeCompare(a.title, 'fa', { sensitivity: 'base' }));
            break;
    }

    renderMadahiList(filtered);
}

/**
 * Renders the paginated list of madahi items to the DOM.
 * @param {Array<Object>} madahiToRender - The array of madahi items (already filtered and sorted) to display.
 */
function renderMadahiList(madahiToRender) {
    const box = document.getElementById("madahiList");
    box.innerHTML = ''; // Clear previous items
    const noMadahiMessage = document.getElementById("noMadahiMessage");
    noMadahiMessage.classList.add("hidden"); // Hide no madahi message by default

    if (madahiToRender.length === 0) {
        noMadahiMessage.classList.remove("hidden");
        document.getElementById("pagination").innerHTML = ''; // Clear pagination if no items
        return;
    }

    const totalPages = Math.ceil(madahiToRender.length / ITEMS_PER_PAGE);
    // Ensure currentPage is within valid range after filtering/sorting
    currentPage = Math.min(currentPage, totalPages);
    currentPage = Math.max(1, currentPage);

    const startIndex = (currentPage - 1) * ITEMS_PER_PAGE;
    const endIndex = startIndex + ITEMS_PER_PAGE;
    const paginatedMadahi = madahiToRender.slice(startIndex, endIndex);

    paginatedMadahi.forEach(item => {
        // Create object URLs for audio and image files
        const audioURL = URL.createObjectURL(item.audio);
        const imageURL = URL.createObjectURL(item.image);

        const isAdmin = getRole() === "admin";
        const adminButtons = isAdmin ? `
            <div class="admin-actions">
                <button class="btn-secondary" onclick="openEditModal(${item.id})"><i class="fas fa-edit"></i> ویرایش</button>
                <button class="btn-danger" onclick="openDeleteConfirmModal(${item.id}, '${item.title.replace(/'/g, "\\'")}')"><i class="fas fa-trash-alt"></i> حذف</button>
            </div>
        ` : '';

        box.innerHTML += `
            <div class="m-item" aria-labelledby="madahi-title-${item.id}">
                <img class="cover" src="${imageURL}" alt="کاور مداحی ${item.title}">
                <h3 id="madahi-title-${item.id}">${item.title}</h3>
                <audio controls src="${audioURL}" aria-label="پخش مداحی ${item.title}"></audio>
                ${adminButtons}
            </div>`;
    });

    renderPagination(totalPages);
}

/**
 * Renders the pagination buttons for navigating through madahi pages.
 * @param {number} totalPages - The total number of pages available.
 */
function renderPagination(totalPages) {
    const paginationContainer = document.getElementById("pagination");
    paginationContainer.innerHTML = ''; // Clear previous pagination

    if (totalPages <= 1) return; // No pagination needed for 1 or less pages

    // Previous page button
    const prevButton = document.createElement('button');
    prevButton.textContent = 'قبلی';
    prevButton.classList.add('btn-secondary');
    prevButton.disabled = currentPage === 1;
    prevButton.onclick = () => {
        if (currentPage > 1) {
            currentPage--;
            filterMadahi();
            window.scrollTo({ top: document.getElementById("madahiListSection").offsetTop, behavior: 'smooth' });
        }
    };
    paginationContainer.appendChild(prevButton);

    // Page number buttons
    for (let i = 1; i <= totalPages; i++) {
        const button = document.createElement('button');
        button.textContent = i;
        button.classList.add('btn-secondary');
        if (i === currentPage) {
            button.classList.add('active');
        }
        button.onclick = () => {
            currentPage = i;
            filterMadahi(); // Re-render with new page
            window.scrollTo({ top: document.getElementById("madahiListSection").offsetTop, behavior: 'smooth' });
        };
        paginationContainer.appendChild(button);
    }

    // Next page button
    const nextButton = document.createElement('button');
    nextButton.textContent = 'بعدی';
    nextButton.classList.add('btn-secondary');
    nextButton.disabled = currentPage === totalPages;
    nextButton.onclick = () => {
        if (currentPage < totalPages) {
            currentPage++;
            filterMadahi();
            window.scrollTo({ top: document.getElementById("madahiListSection").offsetTop, behavior: 'smooth' });
        }
    };
    paginationContainer.appendChild(nextButton);
}

// ==================== Edit & Delete Functionality ====================
let madahiToEditId = null; // Stores the ID of the madahi currently being edited

/**
 * Opens the edit modal and populates it with the details of the selected madahi.
 * @param {number} id - The ID of the madahi item to edit.
 */
async function openEditModal(id) {
    if (getRole() !== "admin") {
        displayMessage("madahiListSection", "شما اجازه ویرایش مداحی ندارید!", "error");
        return;
    }

    const itemToEdit = allMadahi.find(item => item.id === id);
    if (!itemToEdit) {
        displayMessage("madahiListSection", "مداحی برای ویرایش یافت نشد.", "error");
        console.error("Madahi not found for editing, ID:", id);
        return;
    }

    madahiToEditId = id; // Set the global ID for the item being edited

    // Populate the form fields
    document.getElementById('editMadahiId').value = itemToEdit.id;
    document.getElementById('editMadahiTitle').value = itemToEdit.title;

    // Display previews for current audio/image
    const editAudioPreview = document.getElementById('editAudioPreview');
    const editImagePreview = document.getElementById('editImagePreview');
    editAudioPreview.innerHTML = '';
    editImagePreview.innerHTML = '';

    if (itemToEdit.audio) {
        const audioURL = URL.createObjectURL(itemToEdit.audio);
        const audio = document.createElement('audio');
        audio.controls = true;
        audio.src = audioURL;
        editAudioPreview.appendChild(audio);
    }
    if (itemToEdit.image) {
        const imageURL = URL.createObjectURL(itemToEdit.image);
        const img = document.createElement('img');
        img.src = imageURL;
        img.alt = `کاور فعلی مداحی ${itemToEdit.title}`;
        editImagePreview.appendChild(img);
    }

    openModal('editMadahiModal');
    console.log(`Edit modal opened for madahi ID: ${id}`);
}

document.getElementById('editMadahiForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    console.log("Edit Madahi form submitted.");

    const id = parseInt(document.getElementById('editMadahiId').value);
    const newTitleInput = document.getElementById('editMadahiTitle');
    const newAudioFileInput = document.getElementById('editAudioFile');
    const newImageFileInput = document.getElementById('editImageFile');
    const editMadahiMessage = document.getElementById('editMadahiMessage');
    const editTitleError = document.getElementById('editTitleError');

    // Reset validation errors
    editTitleError.classList.add("hidden");
    newTitleInput.classList.remove("invalid");

    if (!newTitleInput.value.trim()) {
        editTitleError.classList.remove("hidden");
        newTitleInput.classList.add("invalid");
        displayMessage("editMadahiMessage", "نام مداحی نمی‌تواند خالی باشد.", "error");
        return;
    }

    if (getRole() !== "admin") {
        displayMessage("editMadahiMessage", "شما اجازه ویرایش مداحی ندارید!", "error");
        return;
    }

    try {
        const transaction = db.transaction([STORE_NAME], "readwrite");
        const store = transaction.objectStore(STORE_NAME);
        const request = store.get(id);

        request.onsuccess = async (event) => {
            const existingItem = event.target.result;
            if (existingItem) {
                existingItem.title = newTitleInput.value.trim();
                if (newAudioFileInput.files[0]) existingItem.audio = newAudioFileInput.files[0];
                if (newImageFileInput.files[0]) existingItem.image = newImageFileInput.files[0];
                existingItem.time = Date.now(); // Update timestamp on edit

                await new Promise((resolve, reject) => {
                    const updateRequest = store.put(existingItem);
                    updateRequest.onsuccess = () => resolve();
                    updateRequest.onerror = event => reject(event.target.error);
                });

                displayMessage("editMadahiMessage", "مداحی با موفقیت ویرایش و ذخیره شد.", "success");
                closeModal('editMadahiModal');
                await loadMadahiItems(); // Reload list to reflect changes
                console.log(`Madahi ID ${id} updated.`);
            } else {
                displayMessage("editMadahiMessage", "مداحی برای ویرایش یافت نشد. ممکن است حذف شده باشد.", "error");
                console.warn(`Attempted to edit non-existent madahi ID: ${id}`);
            }
        };

        request.onerror = event => {
            console.error("Error fetching item for edit:", event.target.error);
            displayMessage("editMadahiMessage", "خطا در یافتن مداحی برای ویرایش.", "error");
        };

    } catch (error) {
        console.error("Error updating madahi:", error);
        displayMessage("editMadahiMessage", `خطا در ویرایش مداحی: ${error.message || error}`, "error");
    }
});

let madahiToDeleteId = null; // Stores the ID of the madahi to be deleted

/**
 * Opens the delete confirmation modal.
 * @param {number} id - The ID of the madahi item to delete.
 * @param {string} title - The title of the madahi item for display in the confirmation message.
 */
function openDeleteConfirmModal(id, title) {
    if (getRole() !== "admin") {
        displayMessage("madahiListSection", "شما اجازه حذف مداحی ندارید!", "error");
        return;
    }
    madahiToDeleteId = id;
    document.getElementById('deleteMadahiTitle').textContent = title;
    openModal('deleteConfirmModal');
    console.log(`Delete confirmation opened for madahi ID: ${id}`);
}

document.getElementById('confirmDeleteButton').addEventListener('click', async () => {
    if (!madahiToDeleteId) {
        console.warn("Delete button clicked but no madahi ID set for deletion.");
        closeModal('deleteConfirmModal');
        return;
    }

    if (getRole() !== "admin") {
        displayMessage("madahiListSection", "شما اجازه حذف مداحی ندارید!", "error");
        closeModal('deleteConfirmModal');
        return;
    }

    try {
        const transaction = db.transaction([STORE_NAME], "readwrite");
        const store = transaction.objectStore(STORE_NAME);

        await new Promise((resolve, reject) => {
            const request = store.delete(madahiToDeleteId);
            request.onsuccess = () => resolve();
            request.onerror = event => reject(event.target.error);
        });

        displayMessage("madahiListSection", "مداحی با موفقیت از لیست حذف شد.", "success");
        closeModal('deleteConfirmModal');
        await loadMadahiItems(); // Reload list after deletion
        console.log(`Madahi ID ${madahiToDeleteId} deleted.`);
        madahiToDeleteId = null; // Reset ID after successful deletion
    } catch (error) {
        console.error("Error deleting madahi:", error);
        displayMessage("madahiListSection", `خطا در حذف مداحی: ${error.message || error}`, "error");
    }
});

// Auto-update (re-load) every 60 seconds - useful for multi-tab scenarios or subtle updates
// This ensures that if content is updated in one tab, other open tabs eventually reflect it.
setInterval(loadMadahiItems, 60000); // Changed to 60 seconds for less frequent background updates
</script>
</body>
</html>